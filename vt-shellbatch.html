<link rel="import" href="./vt-shellworkable.html">

<polymer-element name="vt-shellbatch" extends="vt-shellworkable" attributes="batchname">
  <template>
    <div on-click="{{cycleStatus}}">
      <link rel="stylesheet" href="vt-shellbatch.css"/>
      <template if="{{'' != batchname}}">
        <b>{{batchname}}</b>
      </template>
      <div id="subTasks">
        <content id="subTasksContent" select="vt-shelltask, vt-shellbatch"></content>
      </div>
    </div>
  </template>
  <script>
    (function(){
      var Async = global.require('async');
      
      Polymer('vt-shellbatch',{
        batchname : '',
        bindWorker : function(){
          this.super();
        },
        unbindWorker : function(){
          this.super();
        },
        setWorker : function(iShellWorker){
          this.super(arguments);
          var subWorkableNodes = this.$.subTasksContent.getDistributedNodes();
          for (var i = 0; i < subWorkableNodes.length; i++) {
            subWorkableNodes[i].setWorker(iShellWorker);
          }
        },
        task : function(iCallback){
          iCallback = (iCallback)? iCallback : _.noop;

          var tasks = [];
          var subTasksNodes = this.$.subTasksContent.getDistributedNodes();
          for (var i = 0; i < subTasksNodes.length; i++) {
            var currentTaskNode = subTasksNodes[i];
            tasks.push(currentTaskNode.doTask.bind(currentTaskNode));
          }

          var thisFinishCallback = function(err, results){
            results = _.flatten(results);
            results = _.compact(results);

            iCallback(err, results.join());
          }.bind(this);

          Async.series(tasks, thisFinishCallback);
        }
      });
    })();
  </script>
</polymer-element>