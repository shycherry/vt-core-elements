<link rel="import" href="./vt-shellworkable.html">

<polymer-element name="vt-shelltask" extends="vt-shellworkable" attributes="command">
  <template>
    <link rel="stylesheet" href="vt-shelltask.css"/>
    <div on-click="{{cycleStatus}}">
      <template if="{{injected == command}}">
        {{command}}
      </template>
      <template if="{{injected != command}}">
        {{injected}} - <i>{{command}}</i>
      </template>
    </div>
  </template>
  <script>
    (function(){
      var Async = global.require('async');
      
      Polymer('vt-shelltask',{
        command : "ls",
        injected : "",
        observe: {
          command : 'notifyCommandChanged',
        },
        dataChanged : function(){
          this.command = this.data.command;
        },
        notifyCommandChanged : function(){
          this.fire('commandChanged', {'shelltask' : this});
        },
        bindWorker : function(){
          this.myParamsListener = this.injectWorkerParams.bind(this);
          this.shellworker.addEventListener('params_changed', this.myParamsListener);
          this.super();
        },
        unbindWorker : function(){
          if(this.shellworker && this.myParamsListener)
          {
            this.shellworker.removeEventListener('params_changed', this.myParamsListener);
            delete this.myParamsListener;
          }
          this.super();
        },
        setWorker : function(iShellWorker){
          this.super(arguments);
          this.injectWorkerParams();
        },
        injectWorkerParams : function(){
          var worker = this.shellworker;
          if(! worker) {return;}        
          var injecter = worker.getInjecter();
          if(! injecter) {return;}
          injecter.input = this.command;
          injecter.params = worker.params;
          this.injected = injecter.getInjected();
        },
        doTask : function(iCallback){
          iCallback = (iCallback)? iCallback : _.noop;
          var shellworker = this.shellworker;
          
          if(!shellworker){
            iCallback('no worker');
            return;
          }

          if(this.status != 'enqueued'){
            iCallback();
            return;
          }

          var thisTaskStdoutCallback = function(customEvent){
            this.setAttribute('status', 'working');
            if(this.stdoutCallback){
              this.stdoutCallback(customEvent);
            }
          }.bind(this);

          var thisTaskStderrCallback = function(customEvent){
            this.setAttribute('status', 'working');
            if(this.stderrCallback){
              this.stderrCallback(customEvent);
            }
          }.bind(this);

          var thisTaskFinishedCallback = function(err, result){
            this.setAttribute('status', 'finished');
            if(this.completeCallback){
              this.completeCallback(null, result);
            }
            shellworker.removeEventListener('stdout_data', thisTaskStdoutCallback);
            shellworker.removeEventListener('stderr_data', thisTaskStderrCallback);
            iCallback(err, result);
          }.bind(this);

          shellworker.addEventListener('stdout_data', thisTaskStdoutCallback);
          shellworker.addEventListener('stderr_data', thisTaskStderrCallback);
          shellworker.doShellTask(this, thisTaskFinishedCallback);
        }
      });
    })();
  </script>
</polymer-element>