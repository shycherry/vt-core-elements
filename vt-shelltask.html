<link rel="import" href="./vt-shellworkable.html">
<link rel="import" href="../paper-input/paper-input.html">

<polymer-element name="vt-shelltask" extends="vt-shellworkable" attributes="command">
  <template>
    <link rel="stylesheet" href="vt-shelltask.css"/>
    <div horizontal layout center>
      <shadow id="parent"></shadow>
      <div id="taskview" flex>
        <template if="{{status != 'edit'}}">
          <template if="{{injected != ''}}">
            {{injected}}
          </template>
          <template if="{{injected == ''}}">
            <i>{{command}}</i>
          </template>
        </template>
        <template if="{{status == 'edit'}}">
          <paper-input floatingLabel label="{{injected}}" value="{{command}}"></paper-input>
        </template>
      </div>
    </div>
  </template>
  <script>
    (function(){
      Polymer('vt-shelltask',{
        publish: {
          command : {
            value : "ls",
            reflect : true
          }
        },
        injected : "",
        hasErrors : false,
        observe: {
          command : 'reinjectParams',
          params : 'reinjectParams'
        },
        dataChanged : function(){
          this.command = this.data.command;
        },
        reinjectParams : function(){
          this.$.injecter.input = this.command;
          this.$.injecter.params = this.params;
          this.injected = this.$.injecter.getInjected();
        },
        doTask : function(iWorker, iCallback){
          iCallback = (iCallback)? iCallback : _.noop;
          console.log('doShellTask : ' + this.command);
          var shellworker = iWorker;

          if(!shellworker){
            iCallback('no worker');
            return;
          }

          if(this.status != 'enqueued'){
            iCallback();
            return;
          }

          var thisStdoutCallback = function(customEvent){
            if(this.stdoutCallback){
              this.stdoutCallback(customEvent);
            }
          }.bind(this);

          var thisStderrCallback = function(customEvent){
            console.log("mwaich" + customEvent.toString());
            this.hasErrors = true;
            if(this.stderrCallback){
              this.stderrCallback(customEvent);
            }
          }.bind(this);

          var thisFinishedCallback = function(err, result){
            console.log('finishShellTask : ' + this.command);
            this.status = (this.hasErrors)? 'error' : 'finished';
            this.fire('task_finished', {'src': this, 'data':result});
            shellworker.removeEventListener('stdout_data', thisStdoutCallback);
            shellworker.removeEventListener('stderr_data', thisStderrCallback);
            iCallback(err, result);
          }.bind(this);

          this.status = 'working';
          this.hasErrors = false;
          shellworker.addEventListener('stdout_data', thisStdoutCallback);
          shellworker.addEventListener('stderr_data', thisStderrCallback);
          shellworker.doShellTask(this, thisFinishedCallback);
        }
      });
    })();
  </script>
</polymer-element>