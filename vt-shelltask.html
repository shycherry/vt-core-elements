<link rel="import" href="./vt-shellworkable.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../shy-injecter/shy-injecter.html">

<polymer-element name="vt-shelltask" extends="vt-shellworkable" attributes="command">
  <template>
    <link rel="stylesheet" href="vt-shelltask.css"/>
    <shy-injecter id="injecter"></shy-injecter>
    <paper-item>
      <shadow id="parent"></shadow>
      <template if="{{injected == command}}">
        {{command}}
      </template>
      <template if="{{injected != command}}">
        {{injected}} - <i>{{command}}</i>
      </template>
    </paper-item>
  </template>
  <script>
    (function(){
      Polymer('vt-shelltask',{
        command : "ls",
        injected : "",
        observe: {
          command : 'reinjectParams',
          params : 'reinjectParams'
        },
        dataChanged : function(){
          this.command = this.data.command;
        },
        reinjectParams : function(){
          this.$.injecter.input = this.command;
          this.$.injecter.params = this.params;
          this.injected = this.$.injecter.getInjected();
        },
        doTask : function(iWorker, iCallback){
          iCallback = (iCallback)? iCallback : _.noop;
          console.log('doShellTask : ' + this.command);
          var shellworker = iWorker;
          
          if(!shellworker){
            iCallback('no worker');
            return;
          }

          if(this.status != 'enqueued'){
            iCallback();
            return;
          }

          var thisStdoutCallback = function(customEvent){
            if(this.stdoutCallback){
              this.stdoutCallback(customEvent);
            }
          }.bind(this);

          var thisStderrCallback = function(customEvent){
            if(this.stderrCallback){
              this.stderrCallback(customEvent);
            }
          }.bind(this);
          
          var thisFinishedCallback = function(err, result){
            console.log('finishShellTask : ' + this.command);
            this.status = 'finished';
            if(this.completeCallback){
              this.completeCallback(err, result);
            }
            shellworker.removeEventListener('stdout_data', thisStdoutCallback);
            shellworker.removeEventListener('stderr_data', thisStderrCallback);
            iCallback(err, result);
          }.bind(this);

          this.status = 'working';
          shellworker.doShellTask(this, thisFinishedCallback);
        }
      });
    })();
  </script>
</polymer-element>