<link rel="import" href="./vt-model-element.html">

<polymer-element name="vt-shellworkable" extends="vt-model-element" attributes="status" status="enqueued">
  <template>
    <link rel="stylesheet" href="vt-shellworkable.css"/>
  </template>
  <script type="text/javascript" src="../underscore/underscore.js"></script>
  <script>
    (function(){
      var Async = global.require('async');

      Polymer('vt-shellworkable',{
        status: "enqueued",
        shellworker : null,
        cycleStatus : function(ev){
          ev.stopPropagation();
          if(this.status == 'enqueued')
            this.setAttribute('status', 'canceled');
          else if(this.status == 'canceled')
            this.setAttribute('status', 'enqueued');
        },
        bindWorker : function(){
        },
        unbindWorker : function(){
        },
        setWorker : function(iShellWorker){
          this.unbindWorker();
          this.shellworker = iShellWorker;
          this.bindWorker();
        },
        doTask : function(iCallback){
          iCallback = (iCallback)? iCallback : _.noop;
          this.workOnTask(this.task.bind(this), iCallback);
        },
        workOnTask : function(iTask, iCallback){
          iCallback = (iCallback) ? iCallback : _.noop;
          var shellworker = this.shellworker;
          
          if(!shellworker || !iTask){
            iCallback();
            return;
          }

          if(this.status != 'enqueued'){
            iCallback();
            return;
          }

          var thisStdoutCallback = function(customEvent){
            if(this.stdoutCallback){
              this.stdoutCallback(customEvent);
            }
          }.bind(this);

          var thisStderrCallback = function(customEvent){
            if(this.stderrCallback){
              this.stderrCallback(customEvent);
            }
          }.bind(this);
          
          var thisFinishedCallback = function(err, result){
            this.setAttribute('status', 'finished');
            if(this.completeCallback){
              this.completeCallback(err, result);
            }
            shellworker.removeEventListener('stdout_data', thisStdoutCallback);
            shellworker.removeEventListener('stderr_data', thisStderrCallback);
            iCallback(err, result);
          }.bind(this);

          this.setAttribute('status', 'working');

          iTask(thisFinishedCallback);
        }
      });
    })();
  </script>
</polymer-element>