<link rel="import" href="./vt-model-element.html">

<!-- events: statusChanged (enqueued, canceled, working, dropped) -->
<polymer-element name="vt-shell" extends="vt-model-element">
  <template>
    <link rel="stylesheet" href="vt-shell.css"/>
    <div id="shellContainer">
      <div id="viewport"></div>
      <div id="shelltasksContainer">
        <content id="content" select="vt-shelltask"></content>
      </div>
      <div id="inputbar">
        <input id="commandInput"/>
        <button on-click="{{enqueueCommand}}">Enqueue</button>
      </div>
    </div>
  </template>
  <script>
    var ChildProcess = global.require('child_process');
    var Async = global.require('async');

    Polymer('vt-shell',{      
      created : function(){
        this.queue = Async.queue(this.doShellTask.bind(this), 1);
      },      
      doShellTask : function(iShellTaskElt, iCallback){
        console.log('doShellTask');
        
        if(iShellTaskElt.status == 'canceled'){
          iShellTaskElt.setAttribute("status", "dropped");
          iShellTaskElt.remove();
          if(iCallback) iCallback();
          return;
        }

        iShellTaskElt.setAttribute("status", "working");
        setTimeout(function(){
          iShellTaskElt.setAttribute("status", "finished");
          iShellTaskElt.remove();
          if(iCallback) iCallback();
        }, 1000);
      },
      domReady : function(){
        usershelltasks = this.$.content.getDistributedNodes();        
        usershelltasks.forEach(this.addShellTaskElt.bind(this));
      },
      addShellTaskElt : function(iShellTaskElt){
        console.log('addShellTaskElt');
        if(!iShellTaskElt)
          return;

        iShellTaskElt.setAttribute("status", "enqueued");
        this.$.shelltasksContainer.appendChild(iShellTaskElt);
        this.queue.push(iShellTaskElt);
      },
      addTaskData : function(iTask){
        var newTaskElt = document.createElement('vt-shelltask');        
        newTaskElt.data = iTask;

        this.addShellTaskElt(newTaskElt);
      },
      enqueueCommand : function(){
        var userCmd = this.$.commandInput.value;
        if(!userCmd)
          return;
        
        this.addTaskData({ command: userCmd });
      }
    });
  </script>
</polymer-element>