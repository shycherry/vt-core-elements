<link rel="import" href="./vt-model-element.html">
<link rel="import" href="./vt-shellbatch.html">
<link rel="import" href="./vt-shelltask.html">
<link rel="import" href="./vt-shellworker.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">

<polymer-element name="vt-buttonbatch" extends="vt-shellworkable" attributes="buttonlabel params details">
  <template>
    <shadow></shadow>
    <link rel="stylesheet" href="vt-buttonbatch.css"/>
    <vt-shellworker id="worker"></vt-shellworker>
    <paper-shadow id="shadow" z="1" animated>
      <div id="main" horizontal layout center>
        <paper-icon-button on-click="{{detailsClick}}" icon="menu" title="details" role="button"></paper-icon-button>
        <paper-button id="button" on-click="{{click}}" raised flex>{{injectedlabel}}</paper-button>
      </div>
      <div horizontal layout center>
        <paper-progress id="progress" value="{{$.runbatch.progress}}" flex></paper-progress>
      </div>
      <div id="details">
        <vt-shellbatch status="edit" params="{{params}}">
          <content id="subTasksContent" select="vt-shelltask, vt-shellbatch"></content>
        </vt-shellbatch>
        <vt-shellbatch id="runbatch" status="{{status}}"></vt-shellbatch>
      </div>
    </paper-shadow>
  </template>
  <script>
    (function(){

      var cloneContentToRunBatch = function(){
        var subTasksNodes = this.$.subTasksContent.getDistributedNodes();
        for (var i = 0; i < subTasksNodes.length; i++) {
          var currentNode = subTasksNodes[i];
          if(currentNode.activated){
            var clonedNode = currentNode.cloneNode(true);
            this.$.runbatch.appendChild(clonedNode);
            clonedNode.params = this.params ? this.params : {};
          }
        }
      };

      Polymer('vt-buttonbatch',{
        publish : {
          details : {value : false, reflect : true}
        },
        observe: {
          buttonlabel : 'reinjectParams',
          params : 'reinjectParams'
        },
        reinjectParams : function(){
          this.$.injecter.input = this.buttonlabel;
          this.$.injecter.params = this.params;
          this.injectedlabel = this.$.injecter.getInjected();
        },
        detailsClick : function(){
          this.details = !this.details;
          this.$.shadow.setZ ( (this.$.shadow.z == 1)? 2 : 1) ;
        },
        click : function(){
          this.fire('click', {'src':this});
          while(this.$.runbatch.firstChild){
            this.$.runbatch.removeChild(this.$.runbatch.firstChild);
          }
          cloneContentToRunBatch.call(this);
          this.$.runbatch.status = 'enqueued';
          this.async(this.doTask);
        },
        doTask : function(iWorker, iCallback){
          iCallback = (iCallback)? iCallback : _.noop;
          iWorker = (iWorker)? iWorker : this.$.worker;

          var thisFinishedCallback = function(err, result){
            this.$.button.disabled = false;
            iCallback(err, result);
          }.bind(this);

          this.$.button.disabled = true;
          this.$.runbatch.doTask(iWorker, thisFinishedCallback);
        }
      });
    })();
  </script>
</polymer-element>
